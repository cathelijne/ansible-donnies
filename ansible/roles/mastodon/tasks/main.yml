- name: Create /var/www/vhosts/dedonnie.social/docker
  ansible.builtin.file:
    path: /var/www/vhosts/dedonnie.social/docker
    state: directory

- name: Copy docker-compose.yml
  ansible.builtin.copy:
    src: files/{{ item }}
    dest: /var/www/vhosts/dedonnie.social/docker/{{ item }}
  loop:
  - docker-compose.yml
  - .env.production
  - nginx.sh
  - nginx.conf
  - setup.sh

- name: Deploy mastodon
  community.docker.docker_compose:
    project_src: /var/www/vhosts/dedonnie.social/docker/
    files:
    - docker-compose.yml

- name: Copy nginx.conf
  ansible.builtin.copy:
    src: files/nginx.conf
    dest: /var/www/vhosts/system/dedonnie.social/conf/nginx.conf

- name: Reload nginx
  systemd:
    name: nginx
    state: reloaded
